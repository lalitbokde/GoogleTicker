@model CpaTicker.Areas.admin.Classes.OverrideAffiliate

@{
    ViewBag.Title = "Edit Affiliate Cost";
    ViewBag.hash = Url.Action("index", new { id = ViewContext.RouteData.Values["id"] });
}

<div class="row tspark">
    @Html.Partial("_Sparks")
</div>

<section id="widget-grid">

    <div class="row">

        <div class="table-section col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <div class="table-content">
                <div class="table-title">Edit Affiliate Cost for Campaign <strong>@ViewBag.Campaign.Id</strong></div>

                <!-- NEW COL START -->
                <article>

                    <!-- Widget ID (each widget will need unique ID)-->
                    <div class="jarviswidget" id="wid-id-1" data-widget-editbutton="false" data-widget-custombutton="false" data-widget-deletebutton="false">


                        <!-- widget div-->
                        <div>

                            <!-- widget edit box -->
                            <div class="jarviswidget-editbox">
                                <!-- This area used as dropdown edit box -->

                            </div>
                            <!-- end widget edit box -->
                            <!-- widget content -->
                            <div class="widget-body no-padding">

                                @*@using (Html.BeginForm("overridepayoutcreate", "action", FormMethod.Post, new { @id = "createaction", @class = "smart-form" }))
                                    {*@
                                @*@Html.AntiForgeryToken()*@

                                <form id="editoverride" class="smart-form">
                                    @Html.ValidationSummary(true)
                                    @Html.HiddenFor(model => model.CampaignID, new { @Value = ViewBag.Campaign.Id })
                                    @Html.HiddenFor(model => model.OverridID, new { @Value = ViewBag.OverridID })

                                    <footer>
                                        <nav>
                                            <button class="btn btn-primary" type="button" id="btneditoverride"><i class="fa fa-check"></i> Edit Affiliate Cost</button>
                                            @Html.ActionLink("Back", "AffiliatePayout", new { id = ViewBag.Campaign.Id }, new { @class = "btn btn-default", @id = "back_button" })
                                        </nav>
                                    </footer>

                                    <div class="fieldset">

                                        <div class="row">



                                            <section class="col col-6">
                                                @Html.LabelFor(model => model.AffiliateID, "Affiliate", new { @class = "label" })
                                                <label class="select">
                                                    @Html.DropDownList("AffiliateID", (IEnumerable<SelectListItem>)ViewBag.CampaignId, new { @class = "select2" })
                                                    <i></i>
                                                </label>
                                            </section>

                                            <section id="ActionDiv" class="col col-6">
                                                @Html.LabelFor(model => model.ActionID, "Actions", new { @class = "label" })
                                                <label class="select">
                                                    @Html.DropDownList("ActionID")
                                                    <i></i>
                                                </label>
                                            </section>

                                        </div>



                                    </div>
                                    <fieldset>
                                        <legend>Revenue</legend>
                                        <div class="row">
                                            <section class="col col-6">
                                                @Html.LabelFor(model => model.RevenueType, new { @class = "label" })
                                                <label class="select">
                                                    @Html.EnumDropDownListFor(model => model.RevenueType)
                                                    <i></i>
                                                </label>
                                            </section>
                                            <section class="col col-3" id="rmoney">
                                                @Html.LabelFor(model => model.Revenue, new { @class = "label", id = "rlabel" })
                                                <label class="input">
                                                    <i class="icon-append fa fa-money"></i>
                                                    @Html.TextBoxFor(model => model.Revenue, new { @placeholder = "$ 0.00" })
                                                </label>
                                                @Html.ValidationMessageFor(model => model.Revenue)
                                                <div class="note" id="rmnote">The amount paid by advertisers per conversion.</div>
                                            </section>
                                            <section class="col col-3" id="rpercent">
                                                @Html.LabelFor(model => model.RevenuePercent, new { @class = "label" })
                                                <label class="input">
                                                    <i class="icon-append fa fa-money"></i>
                                                    @Html.TextBoxFor(model => model.RevenuePercent, new { @placeholder = "0.0 %" })
                                                </label>
                                                @Html.ValidationMessageFor(model => model.RevenuePercent)
                                                <div class="note" id="rpnote">The percentage of a sale per conversion paid by advertisers.</div>
                                            </section>
                                        </div>
                                    </fieldset>
                                    <fieldset>
                                        <legend>Payout</legend>
                                        <div class="row">
                                            <section class="col col-6">
                                                @Html.LabelFor(model => model.PayoutType, "Payout Type", new { @class = "label", @placeholder = "0.00" })
                                                <label class="select">
                                                    <select id="PayoutType">
                                                        <option value="CPA">Payout Per Conversion (CPA)</option>
                                                        <option value="CPS">Payout Per Sale (CPS)</option>
                                                        <option value="CPA_CPS">Payout Per Conversion + Payout Per Sale (CPA + CPS)</option>
                                                        <option value="CPC">Payout Per Click (CPC)</option>
                                                        <option value="CPM">Payout Per Thousand Impressions (CPM)</option>
                                                    </select>
                                                    @*@Html.EnumDropDownListFor(model => model.PayoutType)*@
                                                    <i></i>
                                                </label>
                                            </section>
                                            <section class="col col-3" id="cmoney">
                                                @Html.LabelFor(model => model.Payout, new { @class = "label", id = "clabel" })
                                                <label class="input">
                                                    <i class="icon-append fa fa-money"></i>
                                                    @Html.TextBoxFor(model => model.Payout, new { @placeholder = "$ 0.00" })
                                                </label>
                                                @Html.ValidationMessageFor(model => model.Payout)
                                                <div class="note" id="cmnote">The amount paid to affiliates per conversion.</div>
                                            </section>
                                            <section class="col col-3" id="cpercent">
                                                @Html.LabelFor(model => model.PayoutPercent, new { @class = "label" })
                                                <label class="input">
                                                    <i class="icon-append fa fa-money"></i>
                                                    @Html.TextBoxFor(model => model.PayoutPercent, new { @placeholder = "0.0 %" })
                                                </label>
                                                @Html.ValidationMessageFor(model => model.PayoutPercent)
                                                <div class="note" id="cpnote">The percentage of sale per conversion paid to affiliates.</div>
                                            </section>
                                        </div>
                                    </fieldset>
                                </form>
                                @*}*@

                            </div>
                            <!-- end widget content -->

                        </div>
                        <!-- end widget div -->

                    </div>
                    <!-- end widget -->

                </article>
                <!-- END COL -->

            </div>
        </div>

    </div>

</section>

<link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1/themes/ui-lightness/jquery-ui.css" />
<link href="~/Content/NewTheme/Multicolumn/jquery.multiselect.css" rel="stylesheet" />
<script src="~/Content/NewTheme/Multicolumn/jquery.multiselect.js"></script>
<script src="~/Content/NewTheme/Multicolumn/prettify.js"></script>
<script type="text/javascript">
    // DO NOT REMOVE : GLOBAL FUNCTIONS!
    pageSetUp();

    // PAGE RELATED SCRIPTS
    updateBreadCrumb('Campaign/EditOverridePayout');
   // updateBreadCrumb('OverridePayout');
    container = $('#content');
    $.validator.unobtrusive.parse(container);

    $('#submit_button').click(function (e) {
        e.preventDefault();
        var f = this.form;
        //container = $('#content');
        //$.validator.unobtrusive.parse($(f)); // this may be placed better! OJO
        if ($(f).valid()) {
            pajaxSubmit(f, container, '@ViewBag.hash');
        }
        return false; // keeps the page from not refreshing
    });


    $('#PayoutType').change(function () {
        Payout(this.value);
    });

    $("#PayoutType").val('@ViewBag.DDLPayout')

    $("#btneditoverride").click(function () {

        if (CheckValidation()) {
            $.ajax({
                type: "POST",
                // url: "/Action/AddOverridePayout",
                url: '@Url.Action("UpdateAffiliateOverride", "Campaign", new { area = "admin" })',
                // data: Formsdata.serialize(),
                data: "{OverrideID:'" + $("#OverridID").val() + "',ActionID:'" + $("#ActionID").val() + "',CampaignID:'" + $("#CampaignID").val() + "',AffiliateID:'" + $("#AffiliateID").val() + "',_PayoutType:'" + $("#PayoutType").val() + "',Payout:'" + $("#Payout").val() + "',PayoutPercent:'" + $("#PayoutPercent").val() + "',_RevenueType:'" + $("#RevenueType").val() + "',Revenue:'" + $("#Revenue").val() + "',RevenuePercent:'" + $("#RevenuePercent").val() + "'}",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data) {
                    window.location.href = "../admin#/admin/campaign/AffiliatePayout/" + data;
                }
            });
        }
    });

    function CheckValidation() {

        var flag1 = true;
        var flag2 = true;
        var flag3 = true;
        var flag4 = true;
        $("#Payout").removeAttr('style');
        $("#PayoutPercent").removeAttr('style');
        $("#Revenue").removeAttr('style');
        $("#RevenuePercent").removeAttr('style');
        var ptype = $("#PayoutType").val();
        var pout = $("#Payout").val();
        var ppercent = $("#PayoutPercent").val();

        var rtype = $("#RevenueType").val();
        var rout = $("#Revenue").val();
        var rpercent = $("#RevenuePercent").val();

        if (ptype == "CPS" || ptype == "CPA_CPS") {
            if (ppercent == "") { $("#PayoutPercent").css("border", "1px solid red"); flag1 = false; }
            if (pout == "" && ptype == "CPA_CPS") { $("#Payout").css("border", "1px solid red"); flag2 = false; }
        }
        else {
            if (pout == "") { $("#Payout").css("border", "1px solid red"); flag2 = false; }
        }


        if (rtype == "RPS" || rtype == "RPA_RPS") {
            if (rpercent == "") { $("#RevenuePercent").css("border", "1px solid red"); flag3 = false; }
            if (rout == "" && rtype == "RPA_RPS") { $("#Revenue").css("border", "1px solid red"); flag4 = false; }
        }
        else {
            if (rout == "") { $("#Revenue").css("border", "1px solid red"); flag4 = false; }
        }

        if (flag1 == true && flag2 == true && flag3 == true && flag4 == true)
        { return true; }
        else
        { return false; }
    }

    $('#RevenueType').change(function () {
        Revenue(this.value);
    });
    $("#PayoutType").val('@ViewBag.DDLPayout')
    $("#RevenueType").val('@ViewBag.DDLRevenue')

    Payout($('#PayoutType').val());
    function Payout(valueSelected) {
        switch (valueSelected) {
            case "CPA":
                $('#cmoney').show();
                $('#cpercent').hide();
                $("#cmnote").text("The amount paid to affiliates per conversion.");
                $("#clabel").text("Payout Per Conversion");
                $("#ActionDiv").css("display", "block");

                break;
            case "CPS":
                $('#cmoney').hide();
                $('#cpercent').show();
                $("#cmnote").text("The amount paid to affiliates per conversion.");
                $("#clabel").text("Payout per Conversion");
                $("#ActionDiv").css("display", "block");
                break;
            case "CPA_CPS":
                $('#cmoney').show();
                $('#cpercent').show();
                $("#cmnote").text("The amount paid to affiliates per conversion.");
                $("#clabel").text("Payout per Conversion");
                $("#ActionDiv").css("display", "block");
                break;
            case "CPC":
                $('#cmoney').show();
                $('#cpercent').hide();
                $("#cmnote").text("The amount paid to affiliates per click.");
                $("#clabel").text("Payout per Click");
                $("#ActionDiv").css("display", "none");
                break;
            default: // CPM
                $('#cmoney').show();
                $('#cpercent').hide();
                $("#cmnote").text("The amount paid to affiliates per thousand impressions.");
                $("#clabel").text("Payout per Thousand Impressions");
                $("#ActionDiv").css("display", "none");
                break;
        }
    }

    Revenue($('#RevenueType').val());
    function Revenue(valueSelected) {
        switch (valueSelected) {
            case "RPA":
                $('#rmoney').show();
                $('#rpercent').hide();
                $("#rmnote").text("The amount paid by advertisers per conversion.");
                $("#rlabel").text("Revenue per Conversion");
                break;
            case "RPS":
                $('#rmoney').hide();
                $('#rpercent').show();
                $("#rmnote").text("The amount paid by advertisers per conversion.");
                $("#rlabel").text("Revenue per Conversion");
                break;
            case "RPA_RPS":
                $('#rmoney').show();
                $('#rpercent').show();
                $("#rmnote").text("The amount paid by advertisers per conversion.");
                $("#rlabel").text("Revenue per Conversion");
                break;
            case "RPC":
                $('#rmoney').show();
                $('#rpercent').hide();
                $("#rmnote").text("The amount paid by advertisers per click.");
                $("#rlabel").text("Revenue per Click");
                break;
            default: // RPM
                $('#rmoney').show();
                $('#rpercent').hide();
                $("#rmnote").text("The amount paid by advertisers per thousand impressions.");
                $("#rlabel").text("Revenue per Thousand Impressions");
                break;
        }
    }

    /******************** Custom Validation ***************************/

    jQuery.validator.addMethod('requirediftype', function (value, element, params) {
        var propertyId = $(element).attr('data-val-requirediftype-property');
        //get the element by id
        var ddlValue = $('#' + propertyId).first().val();
        var expected = $(element).attr('data-val-requirediftype-expected');

        if (propertyId == "PayoutType") {
            if (ddlValue == 'CPS' || ddlValue == 'CPA_CPS') {
                return value; // return if value has data
            }
            return true;
        }
        else {
            if (ddlValue == 'RPS' || ddlValue == 'RPA_RPS') {
                return value; // return if value has data
            }
            return true;
        }

    }, '');

    jQuery.validator.unobtrusive.adapters.add('requirediftype', {}, function (options) {
        options.rules['requirediftype'] = true;
        options.messages['requirediftype'] = options.message;
    });

    jQuery.validator.addMethod('requiredifnot', function (value, element, params) {
        var propertyId = $(element).attr('data-val-requiredifnot-property');
        //get the element by id
        var ddlValue = $('#' + propertyId).first().val();
        var expected = $(element).attr('data-val-requiredifnot-expected');

        if (ddlValue !== expected) {
            return value; // if value is empty or null then must return false
        }

        return true;

    }, '');

    jQuery.validator.unobtrusive.adapters.add('requiredifnot', {}, function (options) {
        options.rules['requiredifnot'] = true;
        options.messages['requiredifnot'] = options.message;
    });

    /******************** Custom Validation ***************************/

</script>